name: CI

on:
  push:              
  pull_request:     
  workflow_dispatch:

jobs:
  windows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: 3.12.10
      - name: Builder image
        env:
          TARGET_OS: Windows
        run: docker build -t electrum-wine-builder-img ./contrib/build-wine/
      - name: Compile Windows binary
        env:
          TARGET_OS: Windows
        run: docker run --name electrum-wine-builder-cont -v $PWD:/opt/wine64/drive_c/electrum --rm --workdir /opt/wine64/drive_c/electrum/contrib/build-wine electrum-wine-builder-img ./make_win.sh
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: electrum-${{ github.sha }}-windows
          path: contrib/build-wine/dist/*.exe
          if-no-files-found: error
          retention-days: 7
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: electrum-${{ github.sha }}-windows

  appimage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: 3.12.10
      - name: Builder image
        run: docker build -t electrum-appimage-builder-img ./contrib/build-linux/appimage/
      - name: Compile Linux AppImage
        run: docker run --name electrum-appimage-builder-cont -v $PWD:/opt/electrum --rm --workdir /opt/electrum/contrib/build-linux/appimage electrum-appimage-builder-img ./make_appimage.sh
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: electrum-${{ github.sha }}-appimage
          path: dist/*.AppImage
          if-no-files-found: error
          retention-days: 7
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: electrum-${{ github.sha }}-appimage

  tarball:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Builder image
        run: docker build -t electrum-sdist-builder-img ./contrib/build-linux/sdist/
      - name: Compile Linux tarball
        run: docker run --name electrum-sdist-builder-cont -v $PWD:/opt/electrum --rm --workdir /opt/electrum/contrib/build-linux/sdist electrum-sdist-builder-img ./make_sdist.sh
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: electrum-${{ github.sha }}-tarball
          path: dist/*.tar.gz
          if-no-files-found: error
          retention-days: 7
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: electrum-${{ github.sha }}-tarball

  source-only-tarball:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Builder image
        run: docker build -t electrum-source-only-tarball-builder-img ./contrib/build-linux/sdist/
      - name: Compile Linux tarball
        run: docker run --name electrum-source-only-tarball-builder-cont -v $PWD:/opt/electrum --rm --workdir /opt/electrum/contrib/build-linux/sdist --env OMIT_UNCLEAN_FILES=1 electrum-source-only-tarball-builder-img ./make_sdist.sh
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: electrum-${{ github.sha }}-source-only-tarball
          path: dist/*.tar.gz
          if-no-files-found: error
          retention-days: 7
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: electrum-${{ github.sha }}-source-only-tarball

  macos:
      runs-on: macos-13
      steps:
        - uses: actions/checkout@v4

        - name: Set up Python ${{ matrix.python-version }}
          uses: actions/setup-python@v5
          with:
            python-version: 3.12.10

        - uses: maxim-lobanov/setup-xcode@v1
          with:
            xcode-version: 14.1.0

        - name: Install latest CMake
          run: |
            brew update
            brew install cmake || brew upgrade cmake
            cmake --version

        - name: Compile OSX dmg
          run: ./contrib/osx/make_osx.sh

        - name: Upload Artifact
          uses: actions/upload-artifact@v4
          with:
            name: electrum-${{ github.sha }}-macos
            path: dist/*.dmg
            if-no-files-found: error
            retention-days: 7

        - name: Download artifacts
          uses: actions/download-artifact@v4
          with:
            name: electrum-${{ github.sha }}-macos
