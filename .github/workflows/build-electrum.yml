name: Build Electrum (Docker)

on:
  push:
    branches: [master]
  workflow_dispatch:
  schedule:
    - cron: '30 2 * * *' # Nightly builds at 02:30 UTC

jobs:
  build-windows:
    name: "Build Windows (Docker)"
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      
    - name: Build Windows installer
      uses: docker/build-push-action@v5
      with:
        context: ./contrib/build-wine
        tags: electrum-wine-builder
        load: true
        
    - name: Run Windows build script
      run: |
        docker run --rm -v $PWD:/opt/wine64/drive_c/electrum \
          -e CIRRUS_TASK_NAME=build-windows \
          electrum-wine-builder \
          /bin/bash -c "cd /opt/wine64/drive_c/electrum/contrib/build-wine && ./make_win.sh"
          
    - uses: actions/upload-artifact@v4
      with:
        name: electrum-windows
        path: contrib/build-wine/dist/*

  build-appimage:
    name: "Build Linux AppImage (Docker)"
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      
    - name: Build AppImage builder
      uses: docker/build-push-action@v5
      with:
        context: ./contrib/build-linux/appimage
        tags: electrum-appimage-builder
        load: true
        
    - name: Run AppImage build script
      run: |
        docker run --rm -v $PWD:/opt/electrum \
          electrum-appimage-builder \
          /bin/bash -c "cd /opt/electrum && ./contrib/build-linux/appimage/make_appimage.sh"
          
    - uses: actions/upload-artifact@v4
      with:
        name: electrum-appimage
        path: dist/*.AppImage

  build-android:
    name: "Build Android (Docker)"
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      
    - name: Build Android builder
      uses: docker/build-push-action@v5
      with:
        context: ./contrib/android
        tags: electrum-android-builder
        load: true
        
    - name: Run Android build script
      run: |
        docker run --rm -v $PWD:/opt/electrum \
          -e APK_ARCH=arm64-v8a \
          electrum-android-builder \
          /bin/bash -c "cd /opt/electrum && ./contrib/android/make_apk.sh qml arm64-v8a debug"
          
    - uses: actions/upload-artifact@v4
      with:
        name: electrum-android
        path: dist/*.apk
